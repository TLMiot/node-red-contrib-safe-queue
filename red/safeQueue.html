<!--
Copyright 2017 Smart-Tech Controle e Automação

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!-- ------------- SafeQueue In (queue in) ---------------------- -->

<script type="text/x-red" data-template-name="queue in">

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="safe-queue.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]safe-queue.label.name">
    </div>

    <div class="form-row">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="safe-queue.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]safe-queue.label.config">
    </div>

    <div class="form-row">
		<label>&nbsp;</label>
		<input type="checkbox" id="node-input-sendError" style="display: inline-block; width: auto; vertical-align: top;">
		<label for="node-input-sendError" style="width:70%;"><span data-i18n="safe-queue.in.label.send-error"></span></label>
	</div>

</script>

<script type="text/x-red" data-help-name="queue in">
    <p>Node responsible for receiving the messages and storing them on the queue.</p>
    <h3>Input</h3>
    <p>The <b>SafeQueue In</b> saves the whole message and uniquely identifies it by the _msgid property.</p>
    <h3>Output</h3>
    <p><b>on success:</b> The SafeQueue In forwards the message as received.</p>
    <p><b>on error:</b> If the “send on error” option is not marked, this node won’t forward the message.
        With the option marked, an error property will be added  to the message and it will be send.</p>
    <p>The original message is forwarded after being safely stored. In case of a failure, only if the option
        “send on error” is enabled, an “msg.error” property is added to the original message and it’s forwarded.</p>
    <h3>Details</h3>
    <p><b>config parameter:</b> the queue to operate on.</p>
    <p><b>error send parameter:</b> if marked, forwards the original message adding a “msg.error” property.
        If not marked, do not forward the original message in case of error.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('queue in', {
        category: 'safe queue',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            config: {
                value: "",
                type: "queue config"
            },
            sendError:{
                value: true
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "file.png",
        paletteLabel: "queue in",
        label: function () {

            if (this.name) {
                return this.name;
            }

            var name = this._("safe-queue.in.define.name")
            var selectConfig = RED.nodes.node(this.config);

            if (selectConfig) {
                name = selectConfig.label() + ": " + name;
            }

            return name;
        }, labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        }
    });
</script>

<!-- ------------- SafeQueue Out (queue out) -------------------- -->

<script type="text/x-red" data-template-name="queue out">

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="safe-queue.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]safe-queue.label.name">
    </div>

    <div class="form-row">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="safe-queue.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]safe-queue.label.config">
    </div>

</script>

<script type="text/x-red" data-help-name="queue out">
    <p>Node responsible for sending stored messages on queue for further processing.</p>
    <h3>Output</h3>
    <p>The original message as received on <b>SafeQueue In</b>.</p>
    <h3>Details</h3>
    <p><b>config parameter:</b> the queue to operate on.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('queue out', {
        category: 'safe queue',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            config: {
                value: "",
                type: "queue config"
            }
        },
        outputs: 1,
        icon: "file.png",
        paletteLabel: "queue out",
        label: function () {

            if (this.name) {
                return this.name;
            }

            var name = this._("safe-queue.out.define.name")
            var selectConfig = RED.nodes.node(this.config);

            if (selectConfig) {
                name = selectConfig.label() + ": " + name;
            }

            return name;
        }, labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        }
    });
</script>

<!-- ------------- SafeQueue Control (queue control) ------------ -->

<script type="text/x-red" data-template-name="queue control">

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="safe-queue.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]safe-queue.label.name">
    </div>

    <div class="form-row">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="safe-queue.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]safe-queue.label.config">
    </div>

    <div class="form-row">
        <label for="node-input-operation">
            <i class="fa fa-filter"></i>
            <span data-i18n="safe-queue.control.label.operation"></span>
        </label>
        <select type="text" id="node-input-operation">
            <option value="queue-size" data-i18n="safe-queue.operation-options.queue-size"> </option>
            <option value="done-size" data-i18n="safe-queue.operation-options.done-size"> </option>
            <option value="error-size" data-i18n="safe-queue.operation-options.error-size"> </option>
            <option value="delete-done" data-i18n="safe-queue.operation-options.delete-done"> </option>
            <option value="delete-error" data-i18n="safe-queue.operation-options.delete-error"> </option>
            <!-- <option value="delete-queue" data-i18n="safe-queue.operation-options.delete-queue"> </option> -->
            <option value="resend-errors" data-i18n="safe-queue.operation-options.resend-errors"> </option>
            <option value="start-process" data-i18n="safe-queue.operation-options.start-process"> </option>
            <option value="stop-process" data-i18n="safe-queue.operation-options.stop-process"> </option>
        </select>
    </div>

    <div id="node-config-days">
        <div class="form-row">
            <label for="node-input-days">
                <i class="fa fa-calendar"></i>
                <span data-i18n="safe-queue.control.label.days"></span>
            </label>
            <input type="number" id="node-input-days" min="0"> day
        </div>
    </div>


</script>

<script type="text/x-red" data-help-name="queue control">
    <p>Node to control and query the queue.</p>
    <h3>Input</h3>
    <p>Triggers the action defined in the configuration.</p>
    <h3>Details</h3>
    <p><b>config parameter:</b> the queue to operate on.</p>
    <b>operation parameter:</b>
    <p><b>Queue size:</b> check how many items exists on the queue, displays the results on status and send the result
        as “msg.payload”.</p>
    <p><b>Done size:</b> check how many items have already been processed with success, displays the results on status
        and send the result as “msg.payload”.</p>
    <p><b>Error size:</b> check how many items have already been processed with failure, displays the results on status
        and send the result as “msg.payload”.</p>
    <p><b>Delete done:</b> delete the items that have already been processed with success and that are older than the
        amount of days set on “days” parameter, or delete all items if the “days” parameter is equal to 0.</p>
    <p><b>Delete error:</b> delete the items that have already been processed with failure and that are older than the
        amount of days set on “days” parameter, or delete all items if the “days” parameter is equal to 0.</p>
    <p><b>Resend errors:</b> move items back to the queue (retry) that have already been processed with failure newer
        than the amount of days set on “days” parameter, or move all items if the “days” parameter is equalto 0.</p>
    <p><b>Stop process:</b> stop sending messages through SafeQueue Out.</p>
    <p><b>Start process:</b> start sending messages through SafeQueue Out.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('queue control', {
        category: 'safe queue',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            config: {
                value: "",
                type: "queue config"
            },
            operation: {
                value: "queue-size"
            },
            days: {
                value: 0
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "debug.png",
        paletteLabel: "queue control",
        label: function () {

            if (this.name) {
                return this.name;
            }

            var selectOperation = this.operation;
            var selectConfig = RED.nodes.node(this.config);

            if (selectConfig) {
                selectOperation = selectConfig.label() + ": " + selectOperation;
            }

            return selectOperation;

        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {

            var self = this;

            var operation = $('#node-input-operation');
            var daysRow = $('#node-config-days');

            operation.change(function () {
                if (operation.val() == "delete-error" || operation.val() == "delete-done" || operation.val() == "resend-errors") {
                    daysRow.show();
                } else {
                    daysRow.hide();
                }
            });
            operation.change();
        }
    });
</script>

<!-- ------------- SafeQueue Acknowledge (queue ack) ------------ -->

<script type="text/x-red" data-template-name="queue ack">

    <div class="form-row" id="node-ack-name">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="safe-queue.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]safe-queue.label.name">
    </div>

    <div class="form-row" id="node-ack-config">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="safe-queue.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]safe-queue.label.config">
    </div>

</script>

<script type="text/x-red" data-help-name="queue ack">
    <p>Node responsible for the acknowledement of messages sent by <b>SafeQueue Out</b>. All the messages are identified
        by the “msg,_msgid” property.</p>
    <p>This node presents two answers for queue, success or failure. A failure is detected either by a timeout
        (as configured on the queue configuration) or by the presence of a “msg.error” property.</p>
    <h3>Input</h3>
    <p>The <b>SafeQueue ACK</b> processes the information received on <b>msg: msg._msgid</b> and <b>msg.error</b>.</p>
    <h3>Details</h3>
    <p><b>config parameter:</b> the queue to operate on.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('queue ack', {
        category: 'safe queue',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            config: {
                value: "",
                type: "queue config"
            }
        },
        inputs: 1,
        icon: "alert.png",
        align: 'right',
        paletteLabel: "queue ack",
        label: function () {

            if (this.name) {
                return this.name;
            }

            var name = this._("safe-queue.ack.define.name")
            var selectConfig = RED.nodes.node(this.config);

            if (selectConfig) {
                name = selectConfig.label() + ": " + name;
            }

            return name;
        }, labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        }
    });
</script>

<!-- ------------- SafeQueue Config (queue config) -------------- -->

<script type="text/x-red" data-template-name="queue config">

    <div class="form-row">
        <label for="node-config-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="safe-queue.label.name"></span>
        </label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]safe-queue.label.name">
    </div>

    <div class="form-row">
        <label for="node-config-input-storage">
            <i class="fa fa-database"></i>
            <span data-i18n="safe-queue.config.label.storage"></span>
        </label>
        <select type="text" id="node-config-input-storage">
            <option value="fs" data-i18n="safe-queue.storage.file-system"></option>
            <!-- <option value="db" data-i18n="safe-queue.storage.data-base"></option> -->
        </select>
    </div>

    <div class="form-row" id="node-config-queue-config-mode-fs">
        <label for="node-config-input-path">
            <i class="fa fa-folder-open"></i>
            <span data-i18n="safe-queue.label.path"></span>
        </label>
        <input type="text" id="node-config-input-path" data-i18n="[placeholder]safe-queue.label.path">
    </div>


    <div class="form-row" id="node-config-queue-config-mode-db">

        <div class="form-row">
            <label for="node-config-input-urlDataBase">
                <i class="fa fa-tag"></i>
                <span data-i18n="safe-queue.label.url-data-base"></span>
            </label>
            <input type="text" id="node-config-input-urlDataBase" data-i18n="[placeholder]safe-queue.label.url-data-base">
        </div>

        <div class="form-row">
            <label for="node-config-input-portDataBase">
                <i class="fa fa-tag"></i>
                <span data-i18n="safe-queue.label.port-data-base"></span>
            </label>
            <input type="text" id="node-config-input-portDataBase" data-i18n="[placeholder]safe-queue.label.port-data-base">
        </div>

        <div class="form-row">
            <label for="node-config-input-userDataBase">
                <i class="fa fa-tag"></i>
                <span data-i18n="safe-queue.label.user-data-base"></span>
            </label>
            <input type="text" id="node-config-input-userDataBase" data-i18n="[placeholder]safe-queue.label.user-data-base">
        </div>

        <div class="form-row">
            <label for="node-config-input-passwordDataBase">
                <i class="fa fa-tag"></i>
                <span data-i18n="safe-queue.label.password-data-base"></span>
            </label>
            <input type="text" id="node-config-input-passwordDataBase" data-i18n="[placeholder]safe-queue.label.password-data-base">
        </div>

    </div>

    <div class="form-row">
        <label for="node-config-input-timeoutAck">
            <i class="fa fa-clock-o"></i>
            <span data-i18n="safe-queue.config.label.timeout-ack"></span>
        </label>
        <input type="number" id="node-config-input-timeoutAck" min="0"> ms
    </div>

	<div class="form-row">
		<label>&nbsp;</label>
		<input type="checkbox" id="node-config-input-startJob" style="display: inline-block; width: auto; vertical-align: top;">
		<label for="node-config-input-startJob" style="width:70%;"><span data-i18n="safe-queue.config.label.start-job"></span></label>
	</div>

</script>

<script type="text/x-red" data-help-name="queue config">
    <p>Node responsible for configuring the queue operation.</p>
    <h3>Details</h3>
    <p><b>Storage type parameter:</b> defines what type storage the queue use.</p>
    <p><b>Path parameter:</b> defines the path used to persist the queue’s data.</p>
    <p><b>Timeout ACK parameter:</b> defines how long to wait before considering a message to have failed. If set 0,
        the timeout is disabled.</p>
    <p><b>Start job at start:</b> if marked, the queue processing starts with node-red, if not marked, it is necessary
        to send the command <b>Start Process</b> on <b>SafeQueue Control</b>.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('queue config', {
        category: 'config',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            storage: {
                value: "fs",
                required: true
            },
            path: {
                value: "",
                required: true
            },
            timeoutAck: {
                value: "1000",
                validate: RED.validators.number()
            },
            startJob: {
                value: true
            }

        },
        label: function () {
            return this.name || this.path;
        },
        oneditprepare: function () {

            var self = this;

            var storageMode = $('#node-config-input-storage');
            var fsRow = $('#node-config-queue-config-mode-fs');
            var dbRow = $('#node-config-queue-config-mode-db');

            storageMode.change(function () {
                if (storageMode.val() == "fs") {
                    fsRow.show();
                    dbRow.hide();
                } else if (storageMode.val() == "db") {
                    fsRow.hide();
                    dbRow.show();
                } else {
                    fsRow.hide();
                    dbRow.hide();
                }
            });
            storageMode.change();
        }
    });
</script>